# Refactoring Plan: LeadSet Apps Script Codebase

**Goal:** To restructure the LeadSet scripts (`LeadSetMain.js`, `LeadSetCalculation.js`, `LeadSetSheetOperations.js`, `LeadSetUtilities.js`) for better modularity, efficiency, robustness, and maintainability.

**Prerequisites:**
*   **Backup:** Create a backup copy of the entire `LeadSet` folder before starting.
*   **Testing:** Be prepared to test the functionality ("All Lead Set" menu, individual "leads" action) after each major step.

---

**Step 0: Understand the Current Flow**

*   **Goal:** Ensure a clear understanding of the intended high-level process flow before making changes.
*   **Action:** Analyze the main entry points to map out the sequence of operations.
*   ** AI Prompt:**
    ```text
    Analyze LeadSetMain.js, focusing on the processAllLeadSet and updateLeadSetForTechnician functions. Describe the high-level sequence of operations for processing leads for one or all technicians (e.g., find sheets -> get lead data -> calculate commissions -> clear old entries -> write new entries -> update summary). Note which other files/functions seem to be primarily involved in each stage according to the current code structure.
    ```

---

**Step 1: Consolidate Calculation Logic**

*   **Goal:** Ensure all commission calculation logic resides *only* within `LeadSetCalculation.js` and remove redundancy.
*   **Action 1.1:** Identify and move all functions related to determining commission amounts/percentages from other files (`LeadSetMain.js`, `LeadSetSheetOperations.js`) into `LeadSetCalculation.js`. Choose a single, clear function signature for the core calculation (e.g., `calculateLeadCommission(revenue)`). Remove duplicate or near-duplicate calculation functions. Remove the fallback sheet operation functions from `LeadSetCalculation.js`.
*   ** AI Prompt 1.1:**
    ```text
    Read LeadSetCalculation.js, LeadSetSheetOperations.js, and LeadSetMain.js. Identify all functions or code blocks responsible for:
    1.  Calculating lead commission amounts based on revenue tiers (2% <$10k, 3% $10k-<$30k, 4% >=$30k).
    2.  Determining the commission percentage tier.
    3.  Validating revenue input for calculations.
    4.  Formatting notes related to commissions.

    Propose edits to:
    a.  Move ALL identified logic strictly into LeadSetCalculation.js.
    b.  Consolidate the core calculation into a single, robust function (e.g., 'calculateLeadCommission(revenue)') that returns an object like { amount: number, percentage: number }. Ensure it includes revenue validation.
    c.  Remove any duplicate calculation functions from all files.
    d.  Remove the fallback sheet operation functions (writeLeadEntriesFallback, updateLeadSummaryFallback) from LeadSetCalculation.js as they mix concerns.
    ```
*   **Action 1.2:** Update all places in the code (likely in `LeadSetMain.js` and `LeadSetSheetOperations.js`) that previously called the moved/removed calculation functions to now call the new consolidated function(s) in `LeadSetCalculation.js`.
*   ** AI Prompt 1.2:**
    ```text
    Based on the changes proposed in Prompt 1.1, analyze LeadSetMain.js and LeadSetSheetOperations.js. Identify all call sites that previously invoked the moved or removed calculation functions. Propose edits to update these call sites to correctly use the new, consolidated calculation function(s) now residing in LeadSetCalculation.js (e.g., call 'calculateLeadCommission(revenue)').
    ```
*   **Testing:** Verify that calculations still produce the correct commission amounts.

---

**Step 2: Optimize Lead Data Fetching**

*   **Goal:** Read the data from the "Lead Set" sheet only once when processing multiple technicians to improve performance.
*   **Action:** Modify the main batch processing function (`processAllLeadSet` or `processLeadData` in `LeadSetMain.js`) to read the entire "Lead Set" sheet data *before* looping through technicians. Inside the loop, filter this data in memory for the current technician and pass only the relevant subset to the single-technician processing function. The function `getLeadDataForTechnician` in `LeadSetSheetOperations.js` will need modification or replacement.
*   ** AI Prompt 2.1:**
    ```text
    Analyze LeadSetMain.js (specifically the function that processes *all* technicians, likely 'processAllLeadSet' or 'processLeadData') and LeadSetSheetOperations.js (specifically 'getLeadDataForTechnician').

    Propose edits to refactor the main batch processing function in LeadSetMain.js to:
    1.  Find the 'Lead Set' sheet.
    2.  Read its *entire* data range into memory using '.getValues()' *once* before starting the loop over technicians. Handle potential errors (sheet not found, empty sheet).
    3.  Identify the correct column index for 'Lead Generated By' from the header row of the fetched data.
    4.  Inside the loop that iterates through technician names:
        a.  Filter the in-memory data array to extract only the rows matching the current technician's name in the 'Lead Generated By' column.
        b.  Map the filtered rows into the expected lead data object format (customer, businessUnit, completionDate, revenue, etc., using correct column indices).
        c.  Pass this filtered array of lead objects for the *current* technician to the function responsible for processing a single technician (e.g., 'updateLeadSetForTechnician' or a refactored version).
    5.  Modify or remove the 'getLeadDataForTechnician' function in LeadSetSheetOperations.js, as reading the full sheet data repeatedly for each technician is no longer necessary. Ensure the single-technician processing function now accepts the pre-filtered lead data as a parameter instead of calling 'getLeadDataForTechnician' itself.
    ```
*   **Testing:** Verify that "All Lead Set" still processes correctly for all technicians and that performance feels improved if the "Lead Set" sheet is large.

---

**Step 3: Refine Sheet Operations Logic**

*   **Goal:** Ensure `LeadSetSheetOperations.js` strictly handles sheet interactions (reading, writing, finding rows/sections, formatting) robustly and efficiently. Remove non-sheet logic. Reduce file size.
*   **Action 3.1:** Remove any remaining calculation or high-level process logic. Improve robustness by removing hardcoded fallbacks for column indices (error if not found). Ensure consistent use of batch operations.
*   ** AI Prompt 3.1:**
    ```text
    Analyze LeadSetSheetOperations.js.
    1.  Verify that no calculation logic remains (it should call LeadSetCalculation.js).
    2.  Verify that no high-level process orchestration logic remains (e.g., looping through all technicians - this belongs in LeadSetMain.js).
    3.  Analyze functions that find column indices based on headers (like the logic originally in 'getLeadDataForTechnician' or similar patterns in other functions like 'smartWriteLeadDataToSheet'). Propose edits to ensure they *do not* fall back to hardcoded indices (e.g., G=6, C=2). If a required column header (like 'Customer Name', 'Job Total Revenue', 'Lead Generated By') is not found, the function should throw a specific error or return a status indicating failure, rather than proceeding with potentially incorrect indices.
    4.  Review all functions that modify the sheet (write data, clear data, format cells, e.g., 'clearAndWriteLeadEntries', 'smartWriteLeadDataToSheet', 'clearRowsInBatch', 'updateTopSummaryLeadSet'). Propose edits to ensure they consistently use batch Apps Script methods (like getRange(row, col, numRows, numCols).setValues(), .clearContent(), .setNumberFormats()) instead of operating on single cells within loops wherever possible.
    ```
*   **Action 3.2 (Optional but Recommended):** Split the large `LeadSetSheetOperations.js` file into smaller, more focused files.
*   ** AI Prompt 3.2 (Optional):**
    ```text
    The file LeadSetSheetOperations.js is very large. Analyze its functions and propose splitting it into potentially two or three smaller, more focused files based on responsibility. For example:
    -   `LeadSetSheetFinder.gs`: Functions for finding sheets, specific rows (header, empty, section start/end), column indices, existing data markers.
    -   `LeadSetSheetWriter.gs`: Functions for writing data (including smart updates), clearing data, formatting cells, updating summary rows.
    -   `LeadSetSheetReader.gs`: Functions solely dedicated to reading data structures from sheets (if distinct from finding logic).

    List which functions from the original LeadSetSheetOperations.js should belong in each proposed new file. (Actual file creation/moving would be a subsequent step).
    ```
*   **Testing:** Verify sheet operations (writing leads, clearing old ones, updating summaries) still work correctly and robustly, especially if columns in the source or target sheets are rearranged.

---

**Step 4: Clean Up Utilities**

*   **Goal:** Ensure `LeadSetUtilities.js` contains only generic, reusable helper functions, not core application logic or direct sheet modifications.
*   **Action:** Move functions that perform application-specific sheet setup (like creating the `Lead Set` sheet with specific headers) to `SheetOperations` (or the new `SheetWriter` file). Ensure validation functions are pure helpers.
*   ** AI Prompt 4.1:**
    ```text
    Analyze LeadSetUtilities.js.
    1.  Identify the function 'createLeadSetSheet'. Since it creates a sheet with specific headers and formatting for this application, propose edits to move this function into LeadSetSheetOperations.js (or LeadSetSheetWriter.gs if Step 3.2 was done). Update any call sites (likely in LeadSetMain.js or Utilities itself) accordingly.
    2.  Review other functions like 'validateLeadSetSheet', 'validateTechnicianSheetForLeadSet', 'getTechnicianSheets', 'formatDate', 'formatCurrency'. Confirm they are generic helpers and do not contain core process logic or application-specific sheet manipulations beyond simple reading/checking. If any are identified as problematic, suggest moving them to a more appropriate file (Main, SheetOperations, Calculation).
    ```
*   **Testing:** Ensure utility functions are still accessible and work as expected. Verify sheet creation logic still functions if it was moved.

---

**Step 5: Streamline Main Logic**

*   **Goal:** Refine `LeadSetMain.js` to act purely as the orchestrator, coordinating calls to the specialized `Calculation`, `SheetOperations` (or its sub-files), and `Utilities` modules. Remove direct sheet/calculation logic.
*   **Action:** Ensure `LeadSetMain.js` uses the optimized data flow from Step 2. Refactor the single-technician processing logic to clearly call calculation and sheet operation functions. Remove direct sheet interactions and calculations.
*   ** AI Prompt 5.1:**
    ```text
    Analyze LeadSetMain.js.
    1.  Ensure functions like 'processAllLeadSet' and 'updateLeadSetForTechnician' (or their equivalents) primarily orchestrate the workflow.
    2.  Identify and propose edits to remove any remaining direct sheet interactions (e.g., getRange().getValue(), .setValue(), .clearContent(), find* functions that should be in SheetOperations/Finder). Replace these with calls to functions in LeadSetSheetOperations.js (or its sub-files like Finder/Writer).
    3.  Identify and propose edits to remove any remaining direct commission calculations. Replace these with calls to functions in LeadSetCalculation.js.
    4.  Verify that the main processing loop ('processAllLeadSet'/'processLeadData') correctly uses the optimized data fetching strategy (read once, filter in loop) established in Step 2.
    5.  Simplify the single-technician processing function ('updateLeadSetForTechnician' or similar) to clearly show the sequence: receive filtered data -> call Calculation module -> call Sheet Operations module to clear/write/update summary -> handle results/errors.
    6.  Remove any helper functions that now reside in Utilities or Sheet Operations (e.g., sheet finding, specific validation checks that were moved).
    ```
*   **Testing:** Thoroughly test the main entry points ("All Lead Set", individual "leads" action) to ensure the entire process flows correctly through the refactored modules.

---

**Step 6: Final Review and Cleanup**

*   **Goal:** Perform a final pass to catch any remaining issues, inconsistencies, or dead code.
*   **Action:** Review all files for consistency, clarity, comments, and remove any unused functions or variables.
*   ** AI Prompt 6.1:**
    ```text
    Perform a final review of all script files in the LeadSet folder (LeadSetMain.js, LeadSetCalculation.js, LeadSetSheetOperations.js [and any new files like LeadSetSheetFinder/Writer.gs], LeadSetUtilities.js). Check for:
    -   Any remaining code redundancy or logic seemingly misplaced according to the established separation of concerns.
    -   Functions or variables that might be unused (dead code).
    -   Inconsistent naming conventions or unclear comments.
    -   Obvious performance issues missed in earlier steps (e.g., unnecessary loops, redundant sheet calls).
    -   Adequate error handling and user feedback messages (UI alerts).
    Summarize any findings or potential further improvements. Highlight any functions that seem overly complex and might benefit from further breakdown.
    ```
*   **User Action:** Perform final manual testing, including edge cases (no leads for a technician, empty Lead Set sheet, invalid data, missing sheets). Clean up `Logger.log` or `console.log` statements used for debugging if desired. Review the `LeadSet-Function` documentation file and update it to reflect the new code structure if necessary.

--- 