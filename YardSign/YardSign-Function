/**
 * Payroll System - Yard Sign Functionality Documentation
 * 
 * This document explains how the Yard Sign functionality works in the Payroll system.
 */

/**
 * OVERVIEW:
 * The Yard Sign module processes yard sign installations completed by technicians,
 * calculates payments, and updates each technician's payroll sheet with the correct amounts.
 * Each yard sign installation is worth a fixed $25.00 payment to the technician.
 */

/**
 * TRIGGERS AND ENTRY POINTS:
 * 
 * 1. Manual Trigger - Menu Item:
 *    - User clicks "All Yard Signs" in the "Technician Tools" menu
 *    - This calls menuProcessAllYardSigns() in Main.js
 *    - Which then calls processAllYardSigns() after confirmation
 *    - On completion, displays a detailed summary popup of all processed yard signs
 * 
 * 2. Manual Trigger - Action Column:
 *    - User selects "Yard Sign" in column G (Action column) of "Hourly + Spiff Pay" sheet
 *    - This triggers the onEdit() function in Main.js
 *    - Which then calls updateYardSignForTechnician() for the specific technician
 *    - On completion, displays a detailed summary popup for that technician
 */

/**
 * WORKFLOW STEP BY STEP:
 * 
 * A.
 *  Initialization:
 *    1. The initYardSign() function is called to initialize the module
 *    2. The Yard Sign sheet is validated or created with ensureYardSignSheetExists()
 *    3. Required columns are checked (Customer Name, Job #, Business Unit, Completion Date, Jobs Total, Tags, Assigned Technicians)
 * B. For Single Technician (updateYardSignForTechnician):
 *    1. Checks the technician's class in the 'Hourly + Spiff Pay' sheet (Column C). If 'Class 1', skips processing, clears data, sets status to 'Skipped (Class 1)', and exits.
 *    2. Sets Action status to "Processing..." (if not skipped)
 *    3. Gets the Yard Sign sheet and validates it
 *    4. Gets the technician's sheet
 *    5. Checks if the technician is an Apprentice with 0% commission. If so, skips processing, clears data, sets status, and exits.
 *    6. Calls calculateYardSignEntries() to find and calculate entries for this technician (if not skipped).
 *    7. If entries are found, writes data to technician's sheet with writeYardSignDataToSheet(). If no entries found, clears data and sets status.
 *    8. Updates status to "Complete" or "Error" (or relevant "Skipped" status).
 *    9. Displays a summary popup (if not suppressed) with details about the processed yard signs.
 * 
 * C. For All Technicians (processAllYardSigns):
 *    1. Shows confirmation dialog
 *    2. Validates Yard Sign sheet
 *    3. Shows processing dialog
 *    4. Loops through all technicians listed in 'Hourly + Spiff Pay'.
 *    5. For each technician:
 *        a. Checks Class in 'Hourly + Spiff Pay'. If 'Class 1', logs skip, clears data, and proceeds to the next tech.
 *        b. Checks if technician sheet exists. If not, logs skip and proceeds.
 *        c. Calls updateYardSignForTechnician() with suppressPopup=true (which includes Apprentice check and calculations).
 *    6. Shows a comprehensive completion message detailing processed, skipped (Class 1, No Sheet, Errors), and error counts.
 */

/**
 * KEY FUNCTIONS AND THEIR ROLES:
 * 
 * 1. YardSignMain.js:
 *    - initYardSign(): Initializes the module
 *    - updateYardSignForTechnician(): Processes yard signs for one technician
 *    - processAllYardSigns(): Processes yard signs for all technicians
 *    - yardSignSetActionStatus(): Updates status in Action column
 * 
 * 2. YardSignUtilities.js:
 *    - validateYardSignSheet(): Checks if sheet has required columns
 *    - ensureYardSignSheetExists(): Creates/validates the Yard Sign sheet
 *    - processAllYardSignsUtility(): Core function for processing all technicians
 *    - safeOperation(): Safely performs spreadsheet operations
 * 
 * 3. YardSignCalculation.js:
 *    - calculateYardSignEntries(): Finds and calculates entries for a technician
 *    - findColumnIndex(): Locates columns with flexible matching
 *    - safeCalculationOperation(): Safely performs calculation operations
 * 
 * 4. YardSignSheetOperations.js:
 *    - writeYardSignDataToSheet(): Writes yard sign data to technician sheet
 *    - findExistingYardSignRows(): Locates existing yard sign entries in sheet
 *    - updateTopSummaryYardSignPay(): Updates summary section in tech sheet
 *    - writeRemainingYardSignEntries(): Adds new entries to tech sheet
 */

/**
 * DATA FLOW:
 * 
 * 1. Yard Sign sheet contains all yard sign installations with columns:
 *    - Customer Name: Who requested the yard sign
 *    - Job #: Identification number for the yard sign job
 *    - Business Unit: The business unit for the installation
 *    - Completion Date: When it was installed
 *    - Jobs Total: Original value for the job (Note: This column is NOT used for technician payment calculation).
 *    - Tags: Additional tags or notes for the installation (Used for payment calculation).
 *    - Assigned Technicians: Who installed the yard sign
 * 
 * 2. Hourly + Spiff Pay sheet (Column C) determines the technician's Class.
 * 
 * 3. When processed:
 *    - The system first checks the technician's Class in 'Hourly + Spiff Pay'. If 'Class 1', the process is skipped for that technician.
 *    - For eligible technicians (Class 2+), the system finds all yard signs assigned to them in the 'Yard Sign' sheet (matching technician name in Column H).
 *    - Checks the 'Tags' column (Column G) in the *same row* for each assigned yard sign to determine the payment amount:
 *      - If the tag 'Yard Sign w/ Pic' is found (case-insensitive), a payment of $25.00 is calculated.
 *      - Otherwise, a payment of $10.00 is calculated.
 *    - Updates the eligible technician's sheet with:
 *      a. Individual yard sign entries (Customer, Business Unit, Completion Date, Calculated $10/$25 amount, "ST - Yard Sign Tag" note)
 *      b. Yard Sign Spiff in the summary section (row 12) with the *total* calculated amount (sum of individual $10/$25 payments)
 * 
 * 4. Existing yard sign entries in the technician's sheet are updated or removed as needed. If a technician becomes Class 1 or has no entries, existing data is cleared.
 */

/**
 * ERROR HANDLING:
 * 
 * - The system uses multiple try/catch blocks to handle errors gracefully
 * - safeOperation() and safeCalculationOperation() prevent spreadsheet validation errors
 * - Each function logs detailed error messages to the console
 * - The Action column is updated with error status when problems occur
 * - Sheet validation ensures required columns exist before processing
 * - Error messages are displayed in user-friendly popup notifications
 */

/**
 * IMPLEMENTATION DETAILS:
 * 
 * - Flexible column matching allows for variations in column names
 * - Date handling accommodates various date formats
 * - Empty rows and missing data are handled gracefully with defaults
 * - The module maintains existing entries and only updates what's changed
 * - Invalid entries (missing data, etc.) are skipped automatically
 * - Technicians designated as 'Class 1' in the 'Hourly + Spiff Pay' sheet (Column C) are excluded from Yard Sign calculations and payments.
 * - Technicians designated as 'Apprentice' with 0% commission in 'Hourly + Spiff Pay' are also skipped.
 * - A variable payment is applied for each yard sign:
 *    - $25.00 if the 'Tags' column (G) contains 'Yard Sign w/ Pic' (case-insensitive).
 *    - $10.00 otherwise.
 * - Detailed summary popups display processing results
 */

/**
 * TECHNICIAN-SPECIFIC PROCESSING:
 * 
 * 1. Data Management in writeYardSignDataToSheet():
 *    - This function handles writing yard sign data to a technician's sheet
 *    - First updates the summary section with updateTopSummaryYardSignPay()
 *    - Then identifies existing yard sign entries with findExistingYardSignRows()
 *    - Prepares new data for writing with proper formatting
 * 
 * 2. Finding and Deleting Existing Entries:
 *    - The findExistingYardSignRows() function scans column J (index 10) for "yard sign" entries:
 *      a. Gets all values in column J up to the last row
 *      b. Identifies rows where column J contains "yard sign" (case-insensitive)
 *      c. Returns an array of row numbers that match this criteria
 *    - When existing entries are found:
 *      a. Updates rows that should be kept with new data
 *      b. If fewer new entries than existing rows, excess rows are cleared:
 *         ```
 *         for (var j = dataToWrite.length; j < existingYardSignRows.length; j++) {
 *           var excessRow = existingYardSignRows[j];
 *           techSheet.getRange(excessRow, 5, 1, 6).clearContent(); // Clears columns E-J
 *         }
 *         ```
 * 
 * 3. Adding New Entries:
 *    - If more entries than existing rows, writeRemainingYardSignEntries() is called:
 *      a. Finds the header row containing "Customer Name" in column E
 *      b. Searches for the first empty row after the header
 *      c. Writes each entry to the sheet starting at the identified row
 *      d. Applies proper formatting (date format, currency format)
 *    - For technicians like Jonathan Fuentes:
 *      a. Each entry includes customer name, business unit, completion date, calculated amount ($10 or $25)
 *      b. Sets the note field (column I) to "ST - Yard Sign Tag"
 *      c. Sets the type field (column J) to "Yard Sign"
 *      d. Formats the date in column G as MM/dd/yyyy
 *      e. Formats the amount in column H as currency ($10.00 or $25.00)
 * 
 * 4. Data Validation and Error Handling:
 *    - Validates all required fields before processing
 *    - Handles missing data with appropriate defaults
 *    - Logs detailed information about the process
 *    - Uses try/catch blocks to prevent operation failures
 * 
 * 5. Summary Notification:
 *    - After processing, a detailed summary popup is displayed to the user
 *    - For single technician: Shows total yard signs, fixed amount, and details for each entry
 *    - For all technicians: Shows total technicians processed, total yard signs, total amount, 
 *      and breakdown by technician including any errors encountered
 */
