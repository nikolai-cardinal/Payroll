/**
 * Cardinal Payroll System - Spiff/Bonus Data Writer
 * Contains functions for writing Spiff/Bonus data and totals to technician sheets.
 */

/**
* Writes the collected Spiff data into the technician sheet using the new column layout.
* Writes data to columns E-J, with Type column set to 'Spiff'.
*
* @param {Sheet} techSheet The technician's sheet object.
* @param {number} headerRow The 1-based row index of the section's header row.
* @param {Array<Object>} customerData An array of objects, each representing a spiff entry.
*                        Expected properties: customerName, jobBusinessUnit, completionDate, commission, notes
* @return {number} The calculated total spiff amount.
*/
function writeSpiffDataToSheet(techSheet, headerRow, customerData) {
  if (!techSheet || headerRow <= 0 || !customerData) {
    console.error("writeSpiffDataToSheet: Invalid parameters");
    return 0;
  }

  // Find a free row to start writing data
  var dataStartRow = headerRow + 1;
  var nextSectionRow = findNextSectionStart(techSheet, headerRow + 1);
  
  if (nextSectionRow <= 0) {
    nextSectionRow = techSheet.getLastRow() + 1;
  }
  
  // Check if there's data to write
  if (!customerData || customerData.length === 0) {
    console.log("No spiff data provided to write");
    return 0;
  }

  var tz = Session.getScriptTimeZone() || 'America/New_York';
  var totalSpiff = 0;
  
  // Don't insert new rows - only use existing rows
  var availableRows = nextSectionRow - dataStartRow;
  
  // Prepare data array for writing (map to columns E-J)
  var dataToWrite = customerData.map(function(c) {
    var commissionAmount = Number(c.commission || 0);
    totalSpiff += commissionAmount;
    
    var dateObj = tryParseDate(c.completionDate);
    var displayDate = dateObj
      ? Utilities.formatDate(dateObj, tz, 'MM/dd/yyyy')
      : (c.completionDate || "");
    
    return [
      c.customerName || "",       // Column E: Customer Name
      c.jobBusinessUnit || "",    // Column F: Job Business Unit
      displayDate,                // Column G: Completion Date
      commissionAmount,           // Column H: Commission Amount
      c.notes || "",              // Column I: Notes
      "Spiff"                     // Column J: Type
    ];
  });

  // Write data to columns E-J (indices 5-10)
  var rowsToWrite = Math.min(dataToWrite.length, availableRows);
  if (rowsToWrite > 0) {
    var targetRange = techSheet.getRange(dataStartRow, 5, rowsToWrite, 6);
    targetRange.setValues(dataToWrite.slice(0, rowsToWrite));

    // Apply formatting
    techSheet.getRange(dataStartRow, 7, rowsToWrite, 1).setNumberFormat('MM/dd/yyyy'); // Date format
    techSheet.getRange(dataStartRow, 8, rowsToWrite, 1).setNumberFormat('$#,##0.00'); // Currency format
  }

  console.log(`Wrote ${rowsToWrite} spiff entries starting at row ${dataStartRow}, total: ${totalSpiff}`);
  return totalSpiff;
} 