Payroll â†’ Technician KPI Data Pull (Google Apps Script)

Goal

When the Payroll script runs for a technician inside your Payroll Spreadsheet, automatically:
	1.	Read the payâ€‘period text in Hourly + Spiff Pay!F1 (exampleÂ 3/22Â -Â 3/30).
	2.	Use the same start / end dates to filter rows in another GoogleÂ Sheet (IDÂ 1wRbNnKsiD2xEs6CFFFKOuFQnTxQUt8jvcJsowoDfssg, tab Data) where the payroll date lives in columnÂ N.
	3.	From those matching rows, take the percentage value in columnÂ P only for the active technician.
	4.	Write the technicianâ€™s average percentage into their individual tab at cellÂ B15.

Quickâ€‘Reference Variables

PAYROLL_SSID   = SpreadsheetApp.getActiveSpreadsheet()
EXTERNAL_SSID  = '1wRbNnKsiD2xEs6CFFFKOuFQnTxQUt8jvcJsowoDfssg'
PAY_PERIOD_CELL= 'Hourly + Spiff Pay!F1'
EXTERNAL_TAB   = 'Data'
DATE_COL_N     = 14   // zeroâ€‘based index 13 âœ columnÂ N
PCT_COL_P      = 16   // zeroâ€‘based index 15 âœ columnÂ P
TECH_SHEET_CELL= 'B15' // inside each tech sheet



â¸»

Microâ€‘Workflow inÂ Cursor

Notation
âŒ˜KÂ =Â open Cursor command palette
// $Â =Â inline prompt comment that Cursor AI will execute when you hitÂ Tab.

1Â Â·Â Create the new GAS file
	1.	Press âŒ˜K â†’ â€œCreate fileâ€ â†’ PayrollDataPull.gs â–¶ï¸ Enter.
	2.	Immediately paste the following inline prompt and hit Tab:

// $ Insert starter code template for pulling KPI % from external sheet as described in spec.

Cursor will generate a skeleton; if it stalls, paste the finished code from StepÂ 2 below.

2Â Â·Â Replace the skeleton with this finished code

/**
 * pullTechnicianKPI â€“ grabs avg % from external â€œDataâ€ sheet for the active tech.
 * @param {string} techName The technicianâ€™s exact display name.
 * @return {number} Average percentage or 0.
 */
function pullTechnicianKPI(techName) {
  const extSS   = SpreadsheetApp.openById('1wRbNnKsiD2xEs6CFFFKOuFQnTxQUt8jvcJsowoDfssg');
  const dataSh  = extSS.getSheetByName('Data');
  const data    = dataSh.getDataRange().getValues();

  // 1ï¸âƒ£Â Grab payâ€‘period range from active payroll file
  const payrollSS = SpreadsheetApp.getActiveSpreadsheet();
  const periodStr = payrollSS.getSheetByName('Hourly + Spiff Pay')
                         .getRange('F1').getDisplayValue(); // ex "3/22 - 3/30"

  const { start, end } = parseDateRange(periodStr);

  // 2ï¸âƒ£Â Identify column indexes (zeroâ€‘based)
  const header   = data[0];
  const DATE_COL = 13; // columnÂ N
  const PCT_COL  = 15; // columnÂ P
  const TECH_COL = header.findIndex(h => h.toString().trim().toLowerCase() === 'technician');

  let sum = 0, count = 0;
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const rowDate = new Date(row[DATE_COL]);
    if (rowDate >= start && rowDate <= end && row[TECH_COL] === techName) {
      const pct = parseFloat(row[PCT_COL]);
      if (!isNaN(pct)) { sum += pct; count++; }
    }
  }
  const avg = count ? sum / count : 0;

  // 3ï¸âƒ£Â Write result into the technician sheet
  const techSh = payrollSS.getSheetByName(techName);
  if (techSh) techSh.getRange('B15').setValue(avg);
  return avg;
}

/**
 * parseDateRange â€“ converts "3/22 - 3/30" â†’ {start:Date, end:Date}
 * Infers year from today if not supplied.
 */
function parseDateRange(rangeStr) {
  const [s, e] = rangeStr.split('-').map(p => p.trim());
  const year = new Date().getFullYear();
  const start = new Date(`${s}/${year}`);
  const end   = new Date(`${e}/${year}`);
  // Normalise to midnight for safe comparisons
  start.setHours(0,0,0,0); end.setHours(23,59,59,999);
  return { start, end };
}

3Â Â·Â Hook it into the existing Payroll flow

In whichever file hosts runPayroll() (or similar):

function runPayrollForTechnician(techName) {
  // â€¦ existing payroll logic â€¦

  // NEW: pull KPI % & drop into sheet
  pullTechnicianKPI(techName);
}

Cursor prompt:

// $ Inside runPayrollForTechnician(), call pullTechnicianKPI(techName) after totals are written.

4Â Â·Â Deploy &Â Test
	1.	Run â†’ runPayrollForTechnician(â€˜JohnÂ Smithâ€™) in AppsÂ Script UI.
	2.	Confirm JohnÂ Smith tab cellÂ B15 shows a sensible % (e.g.Â 0.83).
	3.	Change Hourly + Spiff Pay!F1 to another range, rerun, verify value changes.

â¸»

Troubleshooting Tips
	â€¢	If avg returnsÂ 0, doubleâ€‘check:
	â€¢	Technician name spelling matches columnÂ G in Data.
	â€¢	ColumnÂ P truly contains numeric % values (not strings like â€œ83%â€ â€“ strip % first if so).
	â€¢	Date range string has no year; the helper infers the currentâ€‘year.
	â€¢	Use Logger.log({rowDate, start, end}) inside the loop to debug date filtering.

â¸»

Done!

You now have an automatic crossâ€‘sheet KPI pull that feeds directly into each technicianâ€™s payroll tab whenever Payroll runs.

Happy coding ğŸš€